name: Auto-Format SQL with Poor Man‚Äôs T-SQL Formatter

on:
  push:  
  pull_request:  

jobs:
  format-sql:
    runs-on: ubuntu-latest

    steps:
      - name: üõé Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: üîÑ Format only changed SQL files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- '*.sql' '*.SQL')

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "‚ö†Ô∏è No changed SQL files found. Skipping formatting."
            exit 0
          fi

          echo "üìÇ Changed SQL files detected:"
          echo "$CHANGED_FILES"

          for file in $CHANGED_FILES; do
            echo "‚ö° Formatting $file..."
            tools/sql/node_modules/.bin/sqlformat --inputFile "$file" --outputFile "$file" --statementBreaks 1 --no-trailingCommas
          done

      - name: üöÄ Commit formatted SQL files
        run: |
          CHANGED_FILES=$(git diff --name-only -- '*.sql' '*.SQL')

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "‚ö†Ô∏è No formatting changes detected. Skipping commit."
            exit 0
          fi

          echo "üîÑ Adding formatted SQL files..."
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          for file in $CHANGED_FILES; do
            git add "$file"
          done

          git commit -m "[CI_SKIP] üîÑ Auto-formatted SQL files" || echo "‚ö†Ô∏è No changes to commit"
          git push || echo "‚ö†Ô∏è No changes to push"